Protogen, the Protocol Generator
================================

The MDI protocol generator, based on msgpack, aims to simplify the communication protocol between MDI devices and servers. It generates the base server and device code that will serialize/deserialize messages and deal with sequences (message A waits for a message B answerâ€¦).

## Dependencies

You will need Ruby version 1.9 (Protogen has been tested on MRI Ruby 1.9.3).

If you want to generate and compile the device-side Java code, you will need a Java development environement. For compatibility with the Morpheus SDK and the current Java version on the device, Java 6 is recommended. You will need the `jar` and `javac` java build tools installed on your system (they come with any Java 6 JDK). It also needs the device core `.jar`. You can find a default `jar` in `config/mdi-framework-3.X.jar`. If you wish to use your own `jar`, you can define it in your configuration file.

(deactivated) You will also need doxygen installed, if you wish to have documentation aside from generated code.

## Usage

Protogen is basically a Ruby script that takes as input a protocol description file and a configuration file, and outputs either Ruby code (to be used with Ragent or the server SDK) or a compiled Java `jar` (to be used on the device), depending on the configuration file.

To generate code, you need to launch:

    bundle exec ruby protogen.rb <protocol_file_path> <configuration_file_path>

where `protocol_file_path` is the path to the file which describes your protocol.
where `configuration_file_path` is the path to the file which will configure how your code will be generated.


## Protocol file

See `doc/protocol_file.md` for a description of the protocol file.

## Configuration file

This files will decribe how the code will be generated. It can either be written by the user, if he wants to generate code on his own, or be generated by a specific platform (the SDK VM for example). They use the JSON syntax.

### Device configuration file

    {
      "plugins":  [
        "mdi_sdk_vm_device_java"
      ],
      "agent_name":"ProtogenAgentTest",
      "device_output_directory":"sdk_defined_directory",
      "java_package":"com.mdi.test.protogen.avril11", /* the name of the java package in which all the code will be generated. */
      "java_outer_classname":"MDIMessages", /* the name of the main generated class. DO NOT CHANGE THIS FOR NOW as you will likely break something. */
      "keep_java_source":false, /* whether the source files are included in the release (they will be copied in the output folder.*/
      "keep_java_jar":true, /* whether the jar is included in the release */
      "mdi_framework_jar":"/home/guillaume/sdk/MDI-SDK-3.0.14-rc1-linux-x86_64/plugins/com.mdi.project.fw_3.0.13.20121016153400/mdi-framework-3.X/simulator/mdi-framework-3.X.jar", /* path to the mdi framework. Used only when compiling java during code generation and to override default framework in config.*/
      "check_protocol_version":"yes" /* optional. If set to yes, the generated code will check that the device and the server use the same protocol file and raise an error if not. */
    }

### Server configuration file

    {
      "plugins":  [
        "mdi_sdk_vm_server_ruby"
      ],
      "agent_name":"ProtogenAgentTest",
      "server_output_directory":"sdk_defined_directory",
      "user_callbacks":"sdk_defined_directory" /* protogen will look for user-defined callbacks in this directory */
      "check_protocol_version":"yes" /* optional */
    }

## Use the Protogen-generated code ###

The file `doc/protogen_for_the_user.md` explains how a developer can use the Protogen generated code.

## Known issues

* When generating device code, Protogen will exit with status 0 (success) even if the compilation of the generated Java code failed. Protogen will output the result of the compilation, check that the compilation was successful. Note that if there are no bugs in Protogen, the compilation should never fail. But in the real life...

* Protogen will split large message send by the server and reassemble them on the device. However, it will not split the messages sent by the device.

## Tests

(Tests have not been updated in a while and are really scarce - do not rely on them).

To launch the protogen tests, you simply have to launch the test.rb script at the root of the protogen. Be sure that the sdk vm is up, and that you have released the same version of the protogen on the vm (using for example "./release_sdk.rb -l").
