<!--
  Xavier Demompion : xavier.demompion@mobile-devices.fr
  Mobile Devices 2013
-->

<div class="well info row well-small">

  <div class="pull-left" style="margin-top:5px">
    <i class="icon-th"></i> : SERVER
    <i class="icon-star"></i> : PRESENCE
    <i class="icon-envelope"></i> : MESSAGE
    <i class="icon-th-list"></i> TRACK
    <i class="icon-fire"></i> : ORDER
    <i class="icon-share"></i> : ACK
  </div>

  <div class="pull-right">
    <% if is_log_show_com() == 'true' %>
      <a class="btn btn-success" href="/log_show_com_hide">com</a>
    <% else %>
      <a class="btn btn-success disabled" href="/log_show_com_show">com</a>
    <% end %>

    <% if is_log_show_process() == 'true' %>
      <a class="btn btn-info" href="/log_show_process_hide">processing</a>
    <% else %>
      <a class="btn btn-info disabled" href="/log_show_process_show">processing</a>
    <% end %>

    <% if is_log_show_error() == 'true' %>
      <a class="btn btn-danger" href="/log_show_error_hide">errors</a>
    <% else %>
      <a class="btn btn-danger disabled" href="/log_show_error_show">errors</a>
    <% end %>
  </div>
</div>

<div class="row-fluid">

  <div class="span4">

    <% logs_agent_punked.each_with_index do | punk, index| %>

      <% punk_kind = "" %>

      <p>
        <button type="button" data-bind="btn" data-content="btn_content_<%= index %>"
          <% if punk.way == 'process' %>
            <% if punk.type == 'ok' %>
              class="btn btn-info btn-block"
              <% punk_kind = "process" %>
            <% elsif punk.type == 'ko' %>
              class="btn btn-danger btn-block"
              <% punk_kind = "error" %>
            <% else %>
              class="btn btn-inverse btn-block"
            <% end %>
          <% else %>
            <% if punk.type == 'ok' %>
              class="btn btn-success btn-block"
              <% punk_kind = "com" %>
            <% elsif punk.type == 'ko' %>
              class="btn btn-danger btn-block"
              <% punk_kind = "error" %>
            <% elsif punk.type == 'system' %>
              class="btn btn-info btn-block"
              <% punk_kind = "process" %>
            <% else %>
              class="btn btn-inverse btn-block"
            <% end %>
          <% end %>

          <% if is_log_show_com() != 'true' && punk_kind == "com" %>
            style="display:none"
          <% end %>
          <% if is_log_show_process() != 'true' && punk_kind == "process" %>
            style="display:none"
          <% end %>
          <% if is_log_show_error() != 'true' && punk_kind == "error" %>
            style="display:none"
          <% end %>
          >

          <p class="text-left"><b>
            [<%= punk.start_time %>]
             <%= PUNK.title_to_html(punk.title) %>
          </b></p>

        </button>

        <textarea id="btn_content_<%= index %>" style="display:none">
          <%= punk.content %>
        </textarea>
      </p>

    <% end %>


    <% crashed = PUNK.gen_server_crash_title %>
    <% if crashed != "" %>
      <button type="button" data-bind="btn" data-content="btn_content_crash" class="btn btn-danger btn-block">
        <p class="text-left"><b>
           <%= crashed %>
        </b></p>
      </button>
      <textarea id="btn_content_crash" style="display:none">
        <%= logs_server %>
      </textarea>
    <% end %>

  </div>

  <div class="span8">
    <small>
      <div id="view_code" class="" data-spy="affix" data-offset-top="40" style="width:800px">
        <i class="icon-arrow-left"></i><em> Click on buttons for details.</em>
      </div>
    </small>
  </div>
</div>

<section id="endlog"></section>


<script>
  function escapeHTML(text) {   return text.replace(/[&<>"'`]/g, function (chr) {     return '&#' + chr.charCodeAt(0) + ';';   }); };

  $(document).ready(function() {

    $("button[data-bind=btn]").bind('click', function() {
      var content = $('#' + $(this).data('content'));
      var lines   = JSON.parse(content.text());
      var sanitizedLines = lines.map(function(line){ return escapeHTML(line)Â });
      $("#view_code").html(sanitizedLines.join('<br />'));
    });

  });
</script>